<?xml version="1.0"?>
<launch>
  <!-- UTM ì¢Œí‘œê³„ ì¸ìˆ˜ ì •ì˜ (citysim_gazebo.world ê¸°ì¤€) -->
  <arg name="utm_zone" default="31" doc="UTM zone number (citysim world: 31)"/>
  <arg name="utm_band" default="N" doc="UTM band letter (citysim world: N)"/>
 
  <!-- ê¸°ì¡´ husky ouster ì‹¤í–‰ -->
  <include file="$(find husky_custom_gazebo)/launch/husky_ouster_gps.launch"/>

  <!-- GPS í† í”½ ìžë™ ë¦´ë ˆì´ (navsat/fix -> gps/fix) -->
  <node pkg="topic_tools" type="relay" name="gps_topic_relay" 
        args="/navsat/fix /gps/fix" output="log"/>

  <!-- í¬ì¸íŠ¸ í´ë¼ìš°ë“œ ì²˜ë¦¬ íŒŒì´í”„ë¼ì¸ -->
  <node pkg="nodelet" type="nodelet" name="pcl_manager" args="manager" output="log"/>
  <!-- Ouster ë°ì´í„° ë‹¤ìš´ìƒ˜í”Œë§ -->
  <node pkg="nodelet" type="nodelet" name="voxel_grid" args="load pcl/VoxelGrid pcl_manager" output="log">
    <remap from="~input" to="/os1/points"/>
    <remap from="~output" to="/filtered_points"/>
    <param name="leaf_size" value="0.10"/>
    <param name="filter_field_name" value="z"/>
    <param name="filter_limit_min" value="-0.5"/>
    <param name="filter_limit_max" value="2.0"/>
  </node>

  <!-- PointCloud2ë¥¼ LaserScanìœ¼ë¡œ ë³€í™˜ -->
  <node pkg="pointcloud_to_laserscan" type="pointcloud_to_laserscan_node" name="pointcloud_to_laserscan" output="log">
    <remap from="cloud_in" to="/filtered_points"/>
    <remap from="scan" to="/scan"/>
    <param name="angle_min" value="-3.14159"/>
    <param name="angle_max" value="3.14159"/>
    <param name="min_height" value="-1"/>
    <param name="max_height" value="2"/>
    <param name="angle_increment" value="0.01"/>
  </node>

  <!-- Move Base (UTM ê¸°ë°˜ ì„¤ì •) -->
  <node pkg="move_base" type="move_base" respawn="false" name="move_base" output="screen">
    <!-- UTM ê¸°ë°˜ config íŒŒì¼ë“¤ ì‚¬ìš© -->
    <rosparam file="$(find husky_dwa_navigation)/config/costmap_common_params.yaml" command="load" ns="global_costmap"/>
    <rosparam file="$(find husky_dwa_navigation)/config/costmap_common_params.yaml" command="load" ns="local_costmap"/>
    <rosparam file="$(find husky_dwa_navigation)/config/local_costmap_params_utm.yaml" command="load"/>
    <rosparam file="$(find husky_dwa_navigation)/config/global_costmap_params_utm.yaml" command="load"/>
    <rosparam file="$(find husky_dwa_navigation)/config/move_base_params.yaml" command="load"/>
    <rosparam file="$(find husky_dwa_navigation)/config/dwa_local_planner_params.yaml" command="load"/>
    
    <!-- UTM ê¸°ë°˜ í”„ë ˆìž„ ì„¤ì • -->
    <param name="global_costmap/global_frame" value="utm"/>
    <param name="global_costmap/robot_base_frame" value="base_link"/>
    <param name="local_costmap/global_frame" value="utm"/>
    <param name="local_costmap/robot_base_frame" value="base_link"/>
    
    <!-- ê¸°ë³¸ ì„¤ì • -->
    <param name="clearing_rotation_allowed" value="true"/>
    <param name="conservative_clear_costmap" value="true"/>
    <param name="recovery_behavior_enabled" value="true"/>
    <param name="controller_patience" value="15.0"/>
    <param name="planner_patience" value="5.0"/>
    <param name="oscillation_timeout" value="10.0"/>
    <param name="oscillation_distance" value="0.5"/>
 
    <!-- í”Œëž˜ë„ˆ ì„¤ì • -->
    <param name="base_local_planner" value="dwa_local_planner/DWAPlannerROS"/>
    <param name="base_global_planner" value="global_planner/GlobalPlanner"/>
    <param name="controller_frequency" value="10.0"/>
    <param name="planner_frequency" value="5.0"/>

    <!-- GlobalPlanner íŒŒë¼ë¯¸í„° -->
    <param name="GlobalPlanner/allow_unknown" value="true"/>
    <param name="GlobalPlanner/use_dijkstra" value="true"/>
    <param name="GlobalPlanner/use_quadratic" value="true"/>
    <param name="GlobalPlanner/use_grid_path" value="false"/>
    <param name="GlobalPlanner/old_navfn_behavior" value="false"/>
  </node>

  <!-- UTM ê¸°ë°˜ Localization ë…¸ë“œ  -->
  <node pkg="husky_dwa_navigation" type="utm_localization_node.py" 
        name="utm_localization" output="log">
    <param name="fixed_frame" value="utm"/>
    <param name="robot_frame" value="base_link"/>
    <param name="odom_frame" value="odom"/>
    <param name="map_frame" value="map"/>
    <param name="utm_zone" value="$(arg utm_zone)"/>
    <param name="utm_band" value="$(arg utm_band)"/>
  </node>

  <!-- ì‹œìŠ¤í…œ ìƒíƒœ ì¶œë ¥ -->
  <param name="system_info" value="=== Husky UTM GPS Navigation System ===
âœ… GPS í† í”½ ìžë™ ì—°ê²°: /navsat/fix -> /gps/fix
âœ… 2D ëª¨ë“œ EKF í™œì„±í™” (Zì¶• ë“œë¦¬í”„íŠ¸ ë°©ì§€)
âœ… UTM ì¢Œí‘œê³„ ê¸°ë°˜ ë„¤ë¹„ê²Œì´ì…˜
ðŸš€ ì´ˆê¸° heading ì„¤ì •: roslaunch husky_dwa_navigation initial_heading_clean.launch"/>

</launch>