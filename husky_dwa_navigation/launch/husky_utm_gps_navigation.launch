<?xml version="1.0"?>
<launch>
  <!-- UTM 좌표계 기반 GPS 네비게이션 launch 파일 (수정된 버전) -->
  
  <!-- 파라미터 설정 -->
  <arg name="world_name" default="clearpath_playpen"/>
  <arg name="utm_zone" default="52"/>  <!-- 한국 기준 UTM Zone -->
  <arg name="utm_band" default="S"/>   <!-- 한국 기준 UTM Band -->
  
  <!-- 가제보 환경과 휴스키 로봇 실행 (GPS 센서 포함) -->
  <!-- 실제 패키지명: husky_custom_gazebo -->
  <include file="$(find husky_custom_gazebo)/launch/husky_ouster_gps.launch"/>

  <!-- GPS Heading 초기화 노드 -->
  <node pkg="husky_dwa_navigation" type="gps_heading_initializer.py" name="gps_heading_initializer" output="screen">
    <param name="fixed_frame" value="utm"/>
    <param name="robot_frame" value="base_link"/>
    <param name="gps_frame" value="gps_link"/>
    <param name="min_speed_threshold" value="0.3"/>    <!-- 최소 이동 속도 (m/s) -->
    <param name="heading_samples" value="15"/>         <!-- heading 계산용 샘플 수 -->
    <param name="forward_distance" value="3.0"/>       <!-- 전방 목표 거리 (m) -->
    <param name="utm_zone" value="$(arg utm_zone)"/>
    <param name="utm_band" value="$(arg utm_band)"/>
  </node>

  <!-- UTM 기반 Localization 노드 -->
  <node pkg="husky_dwa_navigation" type="utm_localization_node.py" name="utm_localization" output="screen">
    <param name="fixed_frame" value="utm"/>
    <param name="robot_frame" value="base_link"/>
    <param name="odom_frame" value="odom"/>
    <param name="map_frame" value="map"/>
    <param name="gps_frame" value="gps_link"/>
    <param name="gps_weight" value="0.7"/>             <!-- GPS 가중치 -->
    <param name="odom_weight" value="0.2"/>            <!-- Odometry 가중치 -->
    <param name="imu_weight" value="0.1"/>             <!-- IMU 가중치 -->
    <param name="max_gps_age" value="2.0"/>            <!-- GPS 데이터 최대 나이 (초) -->
    <param name="utm_zone" value="$(arg utm_zone)"/>
    <param name="utm_band" value="$(arg utm_band)"/>
  </node>

  <!-- 포인트 클라우드 처리 파이프라인 -->
  <node pkg="nodelet" type="nodelet" name="pcl_manager" args="manager" output="screen"/>
  
  <!-- Ouster 데이터 다운샘플링을 위한 VoxelGrid 필터 -->
  <node pkg="nodelet" type="nodelet" name="voxel_grid" args="load pcl/VoxelGrid pcl_manager" output="screen">
    <remap from="~input" to="/os1/points"/>
    <remap from="~output" to="/filtered_points"/>
    <param name="leaf_size" value="0.10"/>
    <param name="filter_field_name" value="z"/>
    <param name="filter_limit_min" value="-0.5"/>
    <param name="filter_limit_max" value="2.0"/>
  </node>

  <!-- PointCloud2를 LaserScan으로 변환 -->
  <node pkg="pointcloud_to_laserscan" type="pointcloud_to_laserscan_node" name="pointcloud_to_laserscan">
    <remap from="cloud_in" to="/filtered_points"/>
    <remap from="scan" to="/scan"/>
    <param name="angle_min" value="-3.14159"/>
    <param name="angle_max" value="3.14159"/>
    <param name="min_height" value="-0.7"/>
    <param name="max_height" value="2"/>
    <param name="angle_increment" value="0.01"/>
  </node>

  <!-- Move Base 네비게이션 스택 (UTM 기반) -->
  <node pkg="move_base" type="move_base" respawn="false" name="move_base" output="screen">
    <!-- UTM 기반 config 파일들 사용 -->
    <rosparam file="$(find husky_dwa_navigation)/config/costmap_common_params.yaml" command="load" ns="global_costmap"/>
    <rosparam file="$(find husky_dwa_navigation)/config/costmap_common_params.yaml" command="load" ns="local_costmap"/>
    <rosparam file="$(find husky_dwa_navigation)/config/local_costmap_params.yaml" command="load"/>
    <rosparam file="$(find husky_dwa_navigation)/config/global_costmap_params_utm.yaml" command="load"/>
    <rosparam file="$(find husky_dwa_navigation)/config/move_base_params.yaml" command="load"/>
    <rosparam file="$(find husky_dwa_navigation)/config/dwa_local_planner_params.yaml" command="load"/>
    
    <!-- UTM 기반 프레임 설정 -->
    <param name="global_costmap/global_frame" value="utm"/>
    <param name="global_costmap/robot_base_frame" value="base_link"/>
    <param name="local_costmap/global_frame" value="utm"/>
    <param name="local_costmap/robot_base_frame" value="base_link"/>
    
    <param name="clearing_rotation_allowed" value="true"/>
    <param name="conservative_clear_costmap" value="true"/>
    <param name="recovery_behavior_enabled" value="true"/>
    <param name="controller_patience" value="15.0"/>
    <param name="planner_patience" value="5.0"/>
    <param name="oscillation_timeout" value="10.0"/>
    <param name="oscillation_distance" value="0.5"/>
    
    <!-- 플래너 설정 -->
    <param name="base_local_planner" value="dwa_local_planner/DWAPlannerROS"/>
    <param name="base_global_planner" value="global_planner/GlobalPlanner"/>
    
    <!-- 플래너 빈도 설정 -->
    <param name="controller_frequency" value="10.0"/>
    <param name="planner_frequency" value="5.0"/>

    <!-- GlobalPlanner 파라미터 -->
    <param name="GlobalPlanner/allow_unknown" value="true"/>
    <param name="GlobalPlanner/use_dijkstra" value="true"/>
    <param name="GlobalPlanner/use_quadratic" value="true"/>
    <param name="GlobalPlanner/use_grid_path" value="false"/>
    <param name="GlobalPlanner/old_navfn_behavior" value="false"/>
  </node>

  <!-- Navigation Manager (GPS waypoints 지원) -->
  <node pkg="husky_dwa_navigation" type="navigation_manager_node.py" name="navigation_manager" output="screen">
    <param name="use_utm_coordinates" value="true"/>
    <param name="utm_frame" value="utm"/>
    <param name="global_costmap_topic" value="/move_base/global_costmap/costmap"/>
    <param name="robot_base_frame" value="base_link"/>
    <param name="switch_service" value="/move_base/set_parameters"/>
    <param name="planner_type_parameter" value="/move_base/base_global_planner"/>
    <param name="default_planner" value="global_planner/GlobalPlanner"/>
    <param name="check_frequency" value="5.0"/>
    <param name="border_tolerance" value="1.0"/>
  </node>

  <!-- Static transform: base_link to gps_link -->
  <node pkg="tf2_ros" type="static_transform_publisher" name="base_to_gps_tf" 
        args="-0.3 0 0.3 0 0 0 base_link gps_link"/>

</launch>